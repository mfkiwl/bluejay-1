BLUEJAY := /home/seankent/bluejay
SIM := /home/seankent/bluejay/sim
TOOLS := $(BLUEJAY)/tools
BUILD := $(BLUEJAY)/build

SOURCES_SV := $(wildcard $(BUILD)/*.sv)

COMP_OPTS_SV := \
	--incr \
	--relax

ELAB_OPTS := \
	--relax

TOP__TB := jay__tb

TESTNAME := basic
TESTLIST := addi slti sltiu slli xori ori andi srli srai addiw slliw srliw sraiw beq bne blt bltu bge bgeu add sub sll slt sltu xor or srl sra and addw subw sllw srlw sraw jal jalr ld lw lh lb
#TESTLIST := jal 
VOUT := $(foreach i, $(TESTLIST), $(addprefix $(SIM)/results/$(TESTNAME)/, $(i:=.vout)))
AOUT := $(foreach i, $(TESTLIST), $(addprefix $(SIM)/results/$(TESTNAME)/, $(i:=.aout)))



diff: $(AOUT) $(VOUT)
	python3 $(TOOLS)/diff.py $(SIM)/results/$(TESTNAME)/ 


$(SIM)/results/$(TESTNAME)/%.vout: .elab.timestamp
	cd $(SIM)/$(TESTNAME) && $(MAKE)
	cp $(SIM)/$(TESTNAME)/$*.txt t.txt 
	xsim $(TOP__TB)__snapshot --tclbatch xsim_cfg.tcl
	cp t.vout $(SIM)/results/$(TESTNAME)/$*.vout

$(SIM)/results/$(TESTNAME)/%.aout: 
	cd $(SIM)/$(TESTNAME) && $(MAKE)
	cd $(SIM)/$(TESTNAME) && $(MAKE)
	python3 $(TOOLS)/asim.py $(SIM)/$(TESTNAME)/$* $@ 



.PHONY: $(SIM)/$(TESTNAME)
$(SIM)/$(TESTNAME):
	cd $@ && $(MAKE)
	

.PHONY: waves
waves: $(TOP__TB)__snapshot.wdb
	xsim --gui $(TOP__TB)__snapshot.wdb

$(TOP__TB)__snapshot.wdb: .elab.timestamp
	xsim $(TOP__TB)__snapshot --tclbatch xsim_cfg.tcl

.elab.timestamp : .comp_sv.timestamp
	xelab -debug all $(ELAB_OPTS) -top $(TOP__TB) -snapshot $(TOP__TB)__snapshot
	touch .elab.timestamp

.comp_sv.timestamp:
	xvlog --sv $(COMP_OPTS_SV) $(SOURCES_SV)
	touch .comp_sv.timestamp


.PHONY: clean 
clean:
	rm -rf *.jou *.log *.pb *.wdb xsim.dir # This deletes all files generated by Vivado
	rm -rf .*.timestamp # This deletes all our timestamps

.PHONY: compile
compile: .comp_sv.timestamp

.PHONY: elaborate
elaborate : .elab.timestamp

.PHONY: simulate
simulate : $(TOP__TB)__snapshot.wdb


